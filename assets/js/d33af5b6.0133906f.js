"use strict";(self.webpackChunksupport=self.webpackChunksupport||[]).push([[893],{1356:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(7462),s=(n(7294),n(3905));n(1839);const r={},i="Kubernetes (K8S)",o={unversionedId:"standards/kubernetes",id:"standards/kubernetes",title:"Kubernetes (K8S)",description:"big picture",source:"@site/docs/standards/kubernetes.md",sourceDirName:"standards",slug:"/standards/kubernetes",permalink:"/docs/standards/kubernetes",draft:!1,editUrl:"https://github.com/socialgouv/support/tree/main/docs/standards/kubernetes.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"S\xe9curit\xe9",permalink:"/docs/standards/securite"},next:{title:"Tests",permalink:"/docs/standards/tests"}},l={},p=[{value:"Best practices : 12 factors apps",id:"best-practices--12-factors-apps",level:2},{value:"<em>Liveness</em> et <em>Readyness probes</em>",id:"liveness-et-readyness-probes",level:3},{value:"Bien logger dans <em>Docker</em> et donc <em>K8s</em>",id:"bien-logger-dans-docker-et-donc-k8s",level:3},{value:"Exposer les m\xe9triques de mon application",id:"exposer-les-m\xe9triques-de-mon-application",level:3},{value:"Privatisation des m\xe9triques",id:"privatisation-des-m\xe9triques",level:4},{value:"Les outils pour utiliser kubernetes",id:"les-outils-pour-utiliser-kubernetes",level:2},{value:"Clients",id:"clients",level:3},{value:"Variable d&#39;environnement dans Kubernetes",id:"variable-denvironnement-dans-kubernetes",level:2},{value:"ConfigMap : Variables de configuration",id:"configmap--variables-de-configuration",level:3},{value:"Ingress : routing vers vos applications",id:"ingress--routing-vers-vos-applications",level:3},{value:"Sealed-secrets : Variables secretes",id:"sealed-secrets--variables-secretes",level:3},{value:"Sceller un secret dans Kubernetes",id:"sceller-un-secret-dans-kubernetes",level:2},{value:"Tester la validit\xe9 d&#39;un sealed-secret",id:"tester-la-validit\xe9-dun-sealed-secret",level:2}],u={toc:p};function c(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,a.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"kubernetes-k8s"},"Kubernetes (K8S)"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"big picture",src:n(4134).Z,title:":size=800x400",width:"1400",height:"904"})),(0,s.kt)("p",null,"Une tr\xe8s bonne introduction \xe0 Kubernetes est lisible ici : ",(0,s.kt)("a",{parentName:"p",href:"https://sendilkumarn.com/blog/kubernetes-for-everyone/"},"https://sendilkumarn.com/blog/kubernetes-for-everyone/")),(0,s.kt)("h2",{id:"best-practices--12-factors-apps"},"Best practices : 12 factors apps"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Il s'agit de 12 principes d'architecture g\xe9n\xe9raux et de processus utiles pour faire tourner une application dans un environnement ",(0,s.kt)("em",{parentName:"p"},"cloud"),". \xc7a s'applique donc directement aux applications qui doivent tourner dans ",(0,s.kt)("em",{parentName:"p"},"K8s"),". Voir aussi ",(0,s.kt)("a",{parentName:"p",href:"https://12factor.net/fr/"},"https://12factor.net/fr/"))),(0,s.kt)("p",null,"Le code applicatif qui \xe0 terme sera d\xe9ploy\xe9 sur un cluster Kubernetes se doit de respecter un certain nombre de r\xe8gles."),(0,s.kt)("p",null,"Les principales recommandations sont:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Versionnement du code (GIT)"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Exposition d\u2019une ",(0,s.kt)("em",{parentName:"strong"},"URL")," de ",(0,s.kt)("em",{parentName:"strong"},"healthcheck"))," sur ",(0,s.kt)("inlineCode",{parentName:"li"},"/healthz")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Application ",(0,s.kt)("em",{parentName:"strong"},"stateless"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Configuration par variables d\u2019environnement")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"La sortie des logs sur la sortie standard ou la sortie d\u2019erreur")),(0,s.kt)("li",{parentName:"ul"},"Gestion du mode d\xe9grad\xe9."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Gestion des arr\xeats/relances de mani\xe8re propre."))),(0,s.kt)("p",null,"Pour aller plus loin : ",(0,s.kt)("a",{parentName:"p",href:"https://blog.octo.com/applications-node-js-a-12-facteurs-partie-1-une-base-de-code-saine/"},"https://blog.octo.com/applications-node-js-a-12-facteurs-partie-1-une-base-de-code-saine/")),(0,s.kt)("h3",{id:"liveness-et-readyness-probes"},(0,s.kt)("em",{parentName:"h3"},"Liveness")," et ",(0,s.kt)("em",{parentName:"h3"},"Readyness probes")),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Kubernetes")," met \xe0 disposisiton deux outils pour permettant aux application de lui signifier leur \xe9tat de sant\xe9 (OK / KO) ainsi que leur capacit\xe9 \xe0 traiter des requ\xeates ou non (Ready / Not Ready)."),(0,s.kt)("p",null,"Il est important que bien exposer une ",(0,s.kt)("em",{parentName:"p"},"URL")," de ",(0,s.kt)("em",{parentName:"p"},"healthcheck")," et de param\xe9trer ces deux ",(0,s.kt)("em",{parentName:"p"},"probes")," pour ne pas subir les fonctions de ",(0,s.kt)("em",{parentName:"p"},"K8S"),", et au contraire en tirer partie (",(0,s.kt)("em",{parentName:"p"},"self-healing"),", ",(0,s.kt)("em",{parentName:"p"},"rolling upgrade"),", etc.)"),(0,s.kt)("p",null,"Tout est expliqu\xe9 ici : ",(0,s.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/"},"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/")),(0,s.kt)("h3",{id:"bien-logger-dans-docker-et-donc-k8s"},"Bien logger dans ",(0,s.kt)("em",{parentName:"h3"},"Docker")," et donc ",(0,s.kt)("em",{parentName:"h3"},"K8s")),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Long story short")," :"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"tous les logs doivent \xeatre envoy\xe9s sur ",(0,s.kt)("inlineCode",{parentName:"li"},"STDOUT")," ou ",(0,s.kt)("inlineCode",{parentName:"li"},"STDERR")),(0,s.kt)("li",{parentName:"ul"},"D\xe8s que c'est possible, utiliser le format de format de sortie ",(0,s.kt)("inlineCode",{parentName:"li"},"JSON")," pour vos logs, et en ",(0,s.kt)("inlineCode",{parentName:"li"},"single-line"),". Ils seront plus facilement indexables dans ",(0,s.kt)("em",{parentName:"li"},"Elasticsearch"),", et donc plus faciles \xe0 exploiter.")),(0,s.kt)("h3",{id:"exposer-les-m\xe9triques-de-mon-application"},"Exposer les m\xe9triques de mon application"),(0,s.kt)("p",null,"Pour faire du profiling comme pour faire de l'analyse sur des donn\xe9es m\xe9tier, vous pouver exposer un endpoint ",(0,s.kt)("inlineCode",{parentName:"p"},"/metrics")," (ou avec un autre path mais c'est une convention) qui sera scrapp\xe9 par ",(0,s.kt)("em",{parentName:"p"},"Prometheus"),", la brique de collecte du cluster K8s."),(0,s.kt)("p",null,"Le format des donn\xe9es expos\xe9es sur ",(0,s.kt)("inlineCode",{parentName:"p"},"/metrics")," doit \xeatre en ",(0,s.kt)("em",{parentName:"p"},"Open Metrics"),", et c'est g\xe9n\xe9ralement dispo dans les ",(0,s.kt)("em",{parentName:"p"},"libs")," & ",(0,s.kt)("em",{parentName:"p"},"frameworks")," que vous utilisez d\xe9j\xe0. Un exemple de ce que l'on peut faire avec NodeJS : ",(0,s.kt)("a",{parentName:"p",href:"https://blog.risingstack.com/node-js-performance-monitoring-with-prometheus/"},"https://blog.risingstack.com/node-js-performance-monitoring-with-prometheus/")),(0,s.kt)("p",null,"Exemple de route ",(0,s.kt)("inlineCode",{parentName:"p"},"/metrics")," :"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"# HELP appname_users_count Nombre total d'utilisateurs\n# TYPE appname_users_count counter\nappname_users_count 7\n# HELP appname_users_7days_count Utilisateurs actifs sur les 7 derniers jours\n# TYPE appname_users_7days_count counter\nappname_active_users_7days_count  0\n# HELP appname_session_count Sessions ouvertes\n# TYPE appname_session_count gauge\nappname_session_count 0\n# HELP appname_publics_products_count Nombre de produits publics\n# TYPE appname_publics_products_count counter\nappname_publics_products_count 9\n# HELP appname_products_count Nombre de produits total\n# TYPE appname_products_count counter\nappname_products_count 13\n# HELP appname_auditlog_count Nombre d'events dans l'auditlog PG\n# TYPE appname_auditlog_count counter\nappname_auditlog_count  245\n")),(0,s.kt)("p",null,"Voir les ",(0,s.kt)("a",{parentName:"p",href:"https://prometheus.io/docs/practices/naming/"},"best practices pour les m\xe9triques Prometheus")),(0,s.kt)("h4",{id:"privatisation-des-m\xe9triques"},"Privatisation des m\xe9triques"),(0,s.kt)("p",null,"Si les m\xe9triques sont confidentielles, le endpoint doit \xeatre s\xe9curis\xe9. Pour cela, ajouter une annotation sur l'ingress nginx pour neutraliser l'acc\xe8s externe :"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"annotations:\n  nginx.ingress.kubernetes.io/configuration-snippet: |\n    location /metrics {\n      deny all;\n      return 403;\n    }\n")),(0,s.kt)("h2",{id:"les-outils-pour-utiliser-kubernetes"},"Les outils pour utiliser kubernetes"),(0,s.kt)("h3",{id:"clients"},"Clients"),(0,s.kt)("p",null,"Le ",(0,s.kt)("a",{parentName:"p",href:"https://k9scli.io/"},"CLI k9s")," permet de monitorer ses d\xe9ploiements, consulter les logs, se connecter en shell \xe0 vos containers... ",(0,s.kt)("a",{parentName:"p",href:"https://rancher.fabrique.social.gouv.fr"},"Rancher")," est un \xe9quivalent en interface web."),(0,s.kt)("p",null,"Pour acc\xe9der \xe0 votre cluster :"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"installer ",(0,s.kt)("inlineCode",{parentName:"li"},"kubectl")," et ",(0,s.kt)("inlineCode",{parentName:"li"},"k9s")),(0,s.kt)("li",{parentName:"ul"},"r\xe9cup\xe9rer votre fichier ",(0,s.kt)("inlineCode",{parentName:"li"},"kubeconfig")," depuis Rancher et le positionner dans ",(0,s.kt)("inlineCode",{parentName:"li"},"~/.kube/config")),(0,s.kt)("li",{parentName:"ul"},"lancer ",(0,s.kt)("inlineCode",{parentName:"li"},"k9s -A --namespace NAMESPACE")," pour acc\xe9der \xe0 votre namespace. enjoy :)")),(0,s.kt)("p",null,"Plus de d\xe9tails sur l'administration kube avec k9s sur la ",(0,s.kt)("a",{parentName:"p",href:"https://k9scli.io/topics/commands/"},"cheatsheet")," ou ",(0,s.kt)("a",{parentName:"p",href:"https://opensource.com/article/20/5/kubernetes-administration"},"cet article"),"."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://grafana.fabrique.social.gouv.fr"},"Grafana")," permet de superviser finement tous les environnements, VMs et bases de donn\xe9es."),(0,s.kt)("p",null,"Vous pouvez \xe9galement consulter tous vos logs applicatifs dans Grafana avec Loki cf ",(0,s.kt)("a",{parentName:"p",href:"/docs/faq#grafana"},"faq")),(0,s.kt)("h2",{id:"variable-denvironnement-dans-kubernetes"},"Variable d'environnement dans Kubernetes"),(0,s.kt)("p",null,"On vous recommande de r\xe9cup\xe9rer vos variables d'environnement dans vos containers avec ",(0,s.kt)("inlineCode",{parentName:"p"},"envFrom"),". Ceci permet de r\xe9cup\xe9rer directement toutes les variables contenues dans une ConfigMap et/ou un Sealed-Secret."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"# [...]\nenvFrom:\n  - configMapRef:\n      name: app-env\n  - secretRef:\n      name: app-env\n")),(0,s.kt)("h3",{id:"configmap--variables-de-configuration"},"ConfigMap : Variables de configuration"),(0,s.kt)("p",null,"Les variables qui configurent le projet dans l'environnement d\xe9ploy\xe9. Ces variables sont pr\xe9dictibles et non-chiffr\xe9es. Example : ",(0,s.kt)("inlineCode",{parentName:"p"},"NODE_ENV=PRODUCTION")),(0,s.kt)("p",null,"Il est recommand\xe9 d'utiliser une ",(0,s.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables"},(0,s.kt)("em",{parentName:"a"},"ConfigMap")," par container")," et par environnement."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'# .k8s/environements/dev/app-env.configmap.yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: app-env\ndata:\n  NODE_ENV: "production"\n  GRAPHQL_ENDPOINT: "http://hasura/v1/graphql"\n  ACCOUNT_MAIL_SENDER: "contact@fabrique.social.gouv.fr"\n  FRONTEND_PORT: "${PORT}"\n  PRODUCTION: "false"\n')),(0,s.kt)("h3",{id:"ingress--routing-vers-vos-applications"},"Ingress : routing vers vos applications"),(0,s.kt)("p",null,"Nos clusters fournissent le routing et les certificats SSL vers vos applications via un ",(0,s.kt)("inlineCode",{parentName:"p"},"nginx ingress controller"),"."),(0,s.kt)("p",null,"Chaque service expos\xe9 de votre application doit d\xe9clarer une ",(0,s.kt)("inlineCode",{parentName:"p"},"ingress rule")," sp\xe9cifique qui peut comporter des annotations sp\xe9cifiques pour cont\xf4ler les param\xe8tres nginx (redirections, auth, rate-limiting...). cf ",(0,s.kt)("a",{parentName:"p",href:"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations"},"annotation ingress nginx"),"."),(0,s.kt)("p",null,"Pour les noms de domaines externes, cf ",(0,s.kt)("a",{parentName:"p",href:"/docs/faq#noms-de-domaines-externes"},"faq")),(0,s.kt)("h3",{id:"sealed-secrets--variables-secretes"},"Sealed-secrets : Variables secretes"),(0,s.kt)("p",null,"Les variables de configuration secretes qui doivent \xeatre chiffr\xe9es. Example : ",(0,s.kt)("inlineCode",{parentName:"p"},"JWT_SECRET=xxxxxxx")),(0,s.kt)("p",null,"Il est recommand\xe9 d'utiliser un ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/bitnami-labs/sealed-secrets"},(0,s.kt)("em",{parentName:"a"},"SealedSecret")," par container")," et par environnement."),(0,s.kt)("p",null,"L'\xe9quipe SRE est en charge de la gestion des valeurs dans le ",(0,s.kt)("em",{parentName:"p"},"SealedSecret")," utilis\xe9s par notre projet en dev comme en prod. Les valeurs de dev sont consultables par les d\xe9veloppeurs de la startup en r\xe9cup\xe9rant le ",(0,s.kt)("em",{parentName:"p"},"Secret")," du m\xeame nom."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},'# .k8s/environements/dev/hasura-env.configmap.yaml\nkind: SealedSecret\napiVersion: bitnami.com/v1alpha1\nmetadata:\n  name: hasura-env\n  creationTimestamp:\n  annotations:\n    sealedsecrets.bitnami.com/cluster-wide: "true"\nspec:\n  template:\n    metadata:\n      name: hasura-env\n      creationTimestamp:\n      annotations:\n        sealedsecrets.bitnami.com/cluster-wide: "true"\n    type: Opaque\n  encryptedData:\n    ACCOUNT_EMAIL_SECRET: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==\n    HASURA_GRAPHQL_ADMIN_SECRET: yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy==\n    HASURA_GRAPHQL_JWT_SECRET: zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz==\n')),(0,s.kt)("h2",{id:"sceller-un-secret-dans-kubernetes"},"Sceller un secret dans Kubernetes"),(0,s.kt)("p",null,"Pour sceller un nouveau secret pour votre application, vous pouvez utiliser l'interface ",(0,s.kt)("a",{parentName:"p",href:"https://socialgouv.github.io/sre-tools"},"WebSeal")),(0,s.kt)("p",null,"Cette application permet de chiffrer votre secret (client-side) pour mettre \xe0 jour vos fichiers de sealed-secrets"),(0,s.kt)("p",null,"Deux cas possibles :"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"D\xe9veloppement")," : le secret est d\xe9chiffrable cluster-wide"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Production")," : le secret est d\xe9chiffrable uniquement pour un ",(0,s.kt)("inlineCode",{parentName:"li"},"namespace")," et un ",(0,s.kt)("inlineCode",{parentName:"li"},"secret name")," donn\xe9.")),(0,s.kt)("p",null,"Pour la ",(0,s.kt)("em",{parentName:"p"},"production")," pensez \xe0 bien \xe0 v\xe9rifier le ",(0,s.kt)("inlineCode",{parentName:"p"},"namespace")," et le ",(0,s.kt)("inlineCode",{parentName:"p"},"secret name")," sp\xe9cifi\xe9. Le ",(0,s.kt)("inlineCode",{parentName:"p"},"secret name")," est le nom du secret li\xe9 \xe0 l'application, par exemple ",(0,s.kt)("inlineCode",{parentName:"p"},"app"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"api")," ou  ",(0,s.kt)("inlineCode",{parentName:"p"},"app-sealed-secret")," ; on peut trouver ce nom dans le champ ",(0,s.kt)("inlineCode",{parentName:"p"},"metadata.name")," du fichier de secret. Ce nom peut-\xeatre indiqu\xe9 dans les d\xe9ploiements (par exemple dans le fichier ",(0,s.kt)("inlineCode",{parentName:"p"},".kube-workflow/values.yaml"),", dans la partie ",(0,s.kt)("inlineCode",{parentName:"p"},"envFrom.secretRef"),"  pour inclure les secrets d\xe9chiffr\xe9s dans l'environnement d'un container)."),(0,s.kt)("p",null,"Copiez-collez ensuite le secret chiffr\xe9 dans votre fichier de sealed-secrets pour le mettre \xe0 jour."),(0,s.kt)("p",null,"L'\xe9quipe SRE est \xe0 votre disposition pour vous aider dans cette d\xe9marche"),(0,s.kt)("h2",{id:"tester-la-validit\xe9-dun-sealed-secret"},"Tester la validit\xe9 d'un sealed-secret"),(0,s.kt)("p",null,"Avant d'envoyer un sealed-secret sur le cluster, il est utile de v\xe9rifier qu'il soit bien chiffr\xe9."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"kubectl --context dev apply -f ./environments/dev/some.sealed-secret.yml")),(0,s.kt)("p",null,"Ensuite, v\xe9rifier dans rancher ou k9s qu'un ",(0,s.kt)("inlineCode",{parentName:"p"},"Secret")," avec les bonnes valeurs a bien \xe9t\xe9 cr\xe9\xe9 dans le bon namespace."),(0,s.kt)("p",null,"\u26a0\ufe0f ceci va \xe9craser l'\xe9ventuel secret du meme namespace/nom existant. pensez \xe0 changer le nom du secret si besoin"),(0,s.kt)("p",null,"\u26a0\ufe0f La manip n'est pas forc\xe9ment possible en prod, car cela \xe9craserait le secret existant. une possibilit\xe9 est de renommer les cl\xe9s du secret pour ne pas impacter les cl\xe9s existantes."))}c.isMDXComponent=!0},4134:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/kubernetes-big-picture-5408d8189624d4b27155b2bd4f607ebf.png"}}]);