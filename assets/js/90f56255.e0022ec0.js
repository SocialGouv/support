"use strict";(self.webpackChunksupport=self.webpackChunksupport||[]).push([[8892],{2016:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>u});var o=t(7462),a=(t(7294),t(3905));t(5657);const r={},s="Images Docker",i={unversionedId:"standards/docker",id:"standards/docker",title:"Images Docker",description:"Les images Docker doivent pouvoir tourner en root-less et tourner avec un uid>0",source:"@site/docs/standards/docker.md",sourceDirName:"standards",slug:"/standards/docker",permalink:"/support/docs/standards/docker",draft:!1,editUrl:"https://github.com/socialgouv/support/tree/master/docs/standards/docker.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"D\xe9veloppement Mobile",permalink:"/support/docs/standards/mobile"},next:{title:"Pr\xe9sentation",permalink:"/support/docs/infrastructure/presentation"}},l={},u=[{value:"Optimisation d&#39;une image Docker pour NodeJS",id:"optimisation-dune-image-docker-pour-nodejs",level:2},{value:"exemple avec Hasura",id:"exemple-avec-hasura",level:2},{value:"exemple avec Strapi",id:"exemple-avec-strapi",level:2}],d={toc:u},p="wrapper";function c(e){let{components:n,...t}=e;return(0,a.kt)(p,(0,o.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"images-docker"},"Images Docker"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Les images Docker doivent pouvoir tourner en ",(0,a.kt)("inlineCode",{parentName:"p"},"root-less")," et tourner avec un uid>0")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Vous devez utiliser uniquement des images Docker officielles et les surcharger \xe9ventuellement")),(0,a.kt)("h2",{id:"optimisation-dune-image-docker-pour-nodejs"},"Optimisation d'une image Docker pour NodeJS"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'# If possible, use slim version as it is smaller\nARG NODE_VERSION=16-slim\n\n#--- Build stage\nFROM node:$NODE_VERSION as build # utiliser uniquement des images officielles\n\n# Build a rootless image for security reasons, and use an user id rather than a user name\nUSER 1000\nWORKDIR /app\n\nCOPY package.json yarn.lock ./\n# Don\'t add "--production" here as dev dependencies are usually required to build the app.\n# Use "--frozen-lockfile" to be sure package.json has not been updated without updating yarn.lock too.\nRUN yarn --frozen-lockfile\n\n# Warning: don\'t forget to have a `.dockerignore` file when doing a `COPY . .` to limit docker build context.\nCOPY . .\n\n# Note: re-run "yarn install" with production flag to remove dev dependencies, and then clean for the run stage\nRUN yarn build && yarn install --production && yarn cache clean\n\n\n#--- Run stage\nFROM node:$NODE_VERSION\n\nUSER 1000\nWORKDIR /app\n\nCOPY --from=build /app/ /app/\n\n# Note: Don\'t use "yarn start" as it doesn\'t handle linux signals (graceful shutdown for instance)\nCMD ["node", "dist/app.js"]\n')),(0,a.kt)("p",null,"Example content of a ",(0,a.kt)("inlineCode",{parentName:"p"},".dockerignore")," file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"*.md\n.git\n**/dist\n**/build\n**/node_modules\n**/.next\n**/.docz\n**/coverage\nnode_modules\nnpm-debug.log\nyarn-error.log\n.next\n")),(0,a.kt)("h2",{id:"exemple-avec-hasura"},"exemple avec Hasura"),(0,a.kt)("p",null,"Cf ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/SocialGouv/emjpm/blob/master/packages/hasura/Dockerfile"},"https://github.com/SocialGouv/emjpm/blob/master/packages/hasura/Dockerfile")),(0,a.kt)("h2",{id:"exemple-avec-strapi"},"exemple avec Strapi"),(0,a.kt)("p",null,"Cf ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/SocialGouv/1000jours/pull/1281/files"},"https://github.com/SocialGouv/1000jours/pull/1281/files")))}c.isMDXComponent=!0}}]);